# Cost-RAG é¢†åŸŸåˆ†æ

## ğŸ“‹ ç›®å½•

- [é¢†åŸŸåˆ†ææ¦‚è¿°](#é¢†åŸŸåˆ†ææ¦‚è¿°)
- [æ ¸å¿ƒé¢†åŸŸè¯†åˆ«](#æ ¸å¿ƒé¢†åŸŸè¯†åˆ«)
- [ä¸šåŠ¡æµç¨‹åˆ†æ](#ä¸šåŠ¡æµç¨‹åˆ†æ)
- [é¢†åŸŸè¾¹ç•Œå®šä¹‰](#é¢†åŸŸè¾¹ç•Œå®šä¹‰)
- [é¢†åŸŸæ¨¡å‹æ¦‚å¿µ](#é¢†åŸŸæ¨¡å‹æ¦‚å¿µ)
- [é™ç•Œä¸Šä¸‹æ–‡æ˜ å°„](#é™ç•Œä¸Šä¸‹æ–‡æ˜ å°„)
- [é¢†åŸŸäº‹ä»¶è®¾è®¡](#é¢†åŸŸäº‹ä»¶è®¾è®¡)

## ğŸ¯ é¢†åŸŸåˆ†ææ¦‚è¿°

Cost-RAGç³»ç»Ÿçš„æ ¸å¿ƒä¸šåŠ¡æ˜¯å·¥ç¨‹é€ ä»·å’¨è¯¢ï¼Œæ¶‰åŠå¤æ‚çš„æˆæœ¬è®¡ç®—ã€æ–‡æ¡£ç®¡ç†ã€æ™ºèƒ½é—®ç­”å’Œå¤šé¡¹ç›®å¯¹æ¯”ã€‚é€šè¿‡é¢†åŸŸé©±åŠ¨è®¾è®¡(DDD)æ–¹æ³•ï¼Œæˆ‘ä»¬å°†å¤æ‚çš„ä¸šåŠ¡é€»è¾‘åˆ†è§£ä¸ºæ¸…æ™°çš„ã€å¯ç®¡ç†çš„é¢†åŸŸæ¨¡å‹ï¼Œç¡®ä¿ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚

### åˆ†ææ–¹æ³•

1. **äº‹ä»¶é£æš´**: è¯†åˆ«é¢†åŸŸä¸­çš„å…³é”®äº‹ä»¶å’Œå‚ä¸è€…
2. **é¢†åŸŸå»ºæ¨¡**: å»ºç«‹æ ¸å¿ƒæ¦‚å¿µå’Œå…³ç³»
3. **è¾¹ç•Œåˆ’åˆ†**: å®šä¹‰æ¸…æ™°çš„é¢†åŸŸè¾¹ç•Œ
4. **ä¸Šä¸‹æ–‡æ˜ å°„**: ç¡®å®šä¸Šä¸‹æ–‡é—´çš„å…³ç³»
5. **æˆ˜ç•¥è®¾è®¡**: åˆ¶å®šé¢†åŸŸæ¶æ„å†³ç­–

### ä¸šåŠ¡ç›®æ ‡

- **ç²¾å‡†ä¼°ç®—**: æä¾›å‡†ç¡®çš„å·¥ç¨‹é€ ä»·ä¼°ç®—
- **æ™ºèƒ½é—®ç­”**: åŸºäºRAGæŠ€æœ¯çš„ä¸“ä¸šé—®ç­”æœåŠ¡
- **çŸ¥è¯†ç®¡ç†**: æ„å»ºå’Œç®¡ç†å·¥ç¨‹é€ ä»·çŸ¥è¯†åº“
- **æˆæœ¬ä¼˜åŒ–**: é€šè¿‡æ•°æ®åˆ†æå®ç°æˆæœ¬ä¼˜åŒ–
- **é£é™©æ§åˆ¶**: è¯†åˆ«å’Œè¯„ä¼°å·¥ç¨‹æˆæœ¬é£é™©

## ğŸ—ï¸ æ ¸å¿ƒé¢†åŸŸè¯†åˆ«

é€šè¿‡ä¸šåŠ¡åˆ†æå’Œé¢†åŸŸä¸“å®¶è®¿è°ˆï¼Œæˆ‘ä»¬è¯†åˆ«å‡ºä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒé¢†åŸŸï¼š

### 1. å·¥ç¨‹é¡¹ç›®ä¼°ç®—é¢†åŸŸ (Project Estimation Domain)

**æ ¸å¿ƒæ¦‚å¿µ**:
- é¡¹ç›® (Project)
- æˆæœ¬ä¼°ç®— (CostEstimate)
- æˆæœ¬åˆ†è§£ (CostBreakdown)
- æˆæœ¬æ¨¡æ¿ (CostTemplate)
- åˆ†éƒ¨åˆ†é¡¹ (CostSection)

**æ ¸å¿ƒèŒè´£**:
- 14çº§åˆ†éƒ¨åˆ†é¡¹å±‚çº§è®¡ç®—
- æˆæœ¬æ¨¡æ¿ç®¡ç†
- ä¼°ç®—ç»“æœéªŒè¯
- æˆæœ¬ä¼˜åŒ–å»ºè®®

### 2. æ–‡æ¡£ç®¡ç†é¢†åŸŸ (Document Management Domain)

**æ ¸å¿ƒæ¦‚å¿µ**:
- æ–‡æ¡£ (Document)
- æ–‡æ¡£ç‰ˆæœ¬ (DocumentVersion)
- æ–‡æ¡£åˆ†å— (DocumentChunk)
- å®ä½“ (Entity)
- å…³ç³» (Relationship)

**æ ¸å¿ƒèŒè´£**:
- æ–‡æ¡£è§£æå’Œå¤„ç†
- OCRæ–‡å­—è¯†åˆ«
- æ–‡æœ¬åˆ†å—å’Œå‘é‡åŒ–
- çŸ¥è¯†å›¾è°±æ„å»º

### 3. æ™ºèƒ½é—®ç­”é¢†åŸŸ (Intelligent Q&A Domain)

**æ ¸å¿ƒæ¦‚å¿µ**:
- æŸ¥è¯¢ (Query)
- å›ç­” (Answer)
- ä¸Šä¸‹æ–‡ (Context)
- å¯¹è¯ (Conversation)
- çŸ¥è¯†æ£€ç´¢ (KnowledgeRetrieval)

**æ ¸å¿ƒèŒè´£**:
- RAGæŸ¥è¯¢å¤„ç†
- ç­”æ¡ˆç”Ÿæˆå’ŒéªŒè¯
- å¯¹è¯ç®¡ç†
- çŸ¥è¯†æ£€ç´¢ä¼˜åŒ–

### 4. å¤šé¡¹ç›®å¯¹æ¯”é¢†åŸŸ (Multi-Project Comparison Domain)

**æ ¸å¿ƒæ¦‚å¿µ**:
- é¡¹ç›®å¯¹æ¯” (ProjectComparison)
- ç›¸ä¼¼æ€§åˆ†æ (SimilarityAnalysis)
- æˆæœ¬æ´å¯Ÿ (CostInsight)
- å¸‚åœºåŸºå‡† (MarketBenchmark)

**æ ¸å¿ƒèŒè´£**:
- Excelæ•°æ®è§£æ
- é¡¹ç›®ç›¸ä¼¼æ€§è®¡ç®—
- æˆæœ¬å·®å¼‚åˆ†æ
- å¸‚åœºå¯¹æ¯”ç ”ç©¶

### 5. çŸ¥è¯†å›¾è°±é¢†åŸŸ (Knowledge Graph Domain)

**æ ¸å¿ƒæ¦‚å¿µ**:
- çŸ¥è¯†å®ä½“ (KnowledgeEntity)
- å®ä½“å…³ç³» (EntityRelation)
- å›¾è°±èŠ‚ç‚¹ (GraphNode)
- æ¨ç†è§„åˆ™ (InferenceRule)

**æ ¸å¿ƒèŒè´£**:
- å®ä½“è¯†åˆ«å’ŒæŠ½å–
- å…³ç³»æ„å»ºå’ŒéªŒè¯
- å›¾è°±æ¨ç†å’ŒæŸ¥è¯¢
- çŸ¥è¯†æ›´æ–°å’Œç»´æŠ¤

## ğŸ“Š ä¸šåŠ¡æµç¨‹åˆ†æ

### æ ¸å¿ƒä¸šåŠ¡æµç¨‹å›¾

```mermaid
graph TD
    A[é¡¹ç›®å¯åŠ¨] --> B[æ–‡æ¡£æ”¶é›†]
    B --> C[æ–‡æ¡£å¤„ç†]
    C --> D[çŸ¥è¯†æå–]
    D --> E[æ¨¡æ¿é€‰æ‹©]
    E --> F[æˆæœ¬ä¼°ç®—]
    F --> G[ç»“æœéªŒè¯]
    G --> H[æŠ¥å‘Šç”Ÿæˆ]

    I[ç”¨æˆ·æŸ¥è¯¢] --> J[é—®é¢˜ç†è§£]
    J --> K[çŸ¥è¯†æ£€ç´¢]
    K --> L[ç­”æ¡ˆç”Ÿæˆ]
    L --> M[ç»“æœè¿”å›]

    N[å¤šé¡¹ç›®å¯¹æ¯”] --> O[æ•°æ®è§£æ]
    O --> P[ç›¸ä¼¼æ€§åˆ†æ]
    P --> Q[æˆæœ¬å¯¹æ¯”]
    Q --> R[æ´å¯Ÿç”Ÿæˆ]

    subgraph "ä¼°ç®—æµç¨‹"
        B --> C --> D --> E --> F --> G --> H
    end

    subgraph "é—®ç­”æµç¨‹"
        I --> J --> K --> L --> M
    end

    subgraph "å¯¹æ¯”æµç¨‹"
        N --> O --> P --> Q --> R
    end
```

### å…³é”®ä¸šåŠ¡äº‹ä»¶

| äº‹ä»¶åç§° | è§¦å‘æ¡ä»¶ | å½±å“èŒƒå›´ | ä¸šåŠ¡ä»·å€¼ |
|----------|----------|----------|----------|
| ProjectCreated | æ–°é¡¹ç›®åˆ›å»º | ä¼°ç®—é¢†åŸŸ | å¯åŠ¨æˆæœ¬ä¼°ç®—æµç¨‹ |
| DocumentUploaded | æ–‡æ¡£ä¸Šä¼ å®Œæˆ | æ–‡æ¡£é¢†åŸŸ | å¢åŠ çŸ¥è¯†åº“å†…å®¹ |
| CostCalculated | æˆæœ¬è®¡ç®—å®Œæˆ | ä¼°ç®—é¢†åŸŸ | æä¾›ä¼°ç®—ç»“æœ |
| QuerySubmitted | ç”¨æˆ·æäº¤æŸ¥è¯¢ | é—®ç­”é¢†åŸŸ | æä¾›æ™ºèƒ½å›ç­” |
| ComparisonCompleted | å¯¹æ¯”åˆ†æå®Œæˆ | å¯¹æ¯”é¢†åŸŸ | æä¾›å¯¹æ¯”æ´å¯Ÿ |

## ğŸ¨ é¢†åŸŸè¾¹ç•Œå®šä¹‰

### é¢†åŸŸè¾¹ç•Œå›¾

```mermaid
graph LR
    subgraph "ç”¨æˆ·ç•Œé¢å±‚"
        UI[ç”¨æˆ·ç•Œé¢]
    end

    subgraph "åº”ç”¨æœåŠ¡å±‚"
        AS[åº”ç”¨æœåŠ¡]
    end

    subgraph "é¢†åŸŸå±‚"
        PE[é¡¹ç›®ä¼°ç®—é¢†åŸŸ]
        DM[æ–‡æ¡£ç®¡ç†é¢†åŸŸ]
        QA[é—®ç­”é¢†åŸŸ]
        PC[å¯¹æ¯”é¢†åŸŸ]
        KG[çŸ¥è¯†å›¾è°±é¢†åŸŸ]
    end

    subgraph "åŸºç¡€è®¾æ–½å±‚"
        INF[åŸºç¡€è®¾æ–½æœåŠ¡]
    end

    UI --> AS
    AS --> PE
    AS --> DM
    AS --> QA
    AS --> PC
    AS --> KG

    PE --> INF
    DM --> INF
    QA --> INF
    PC --> INF
    KG --> INF
```

### é¢†åŸŸé—´åä½œå…³ç³»

| æºé¢†åŸŸ | ç›®æ ‡é¢†åŸŸ | åä½œæ–¹å¼ | æ¥å£å®šä¹‰ |
|--------|----------|----------|----------|
| æ–‡æ¡£ç®¡ç† | é¡¹ç›®ä¼°ç®— | æä¾›æˆæœ¬æ•°æ® | CostDataService |
| æ–‡æ¡£ç®¡ç† | é—®ç­”é¢†åŸŸ | æä¾›çŸ¥è¯†å†…å®¹ | KnowledgeRetrievalService |
| çŸ¥è¯†å›¾è°± | é—®ç­”é¢†åŸŸ | æä¾›å®ä½“å…³ç³» | GraphQueryService |
| é¡¹ç›®ä¼°ç®— | å¯¹æ¯”é¢†åŸŸ | æä¾›ä¼°ç®—æ•°æ® | EstimateDataService |
| å¤šé¡¹ç›®å¯¹æ¯” | é¡¹ç›®ä¼°ç®— | æä¾›åŸºå‡†æ•°æ® | BenchmarkDataService |

## ğŸ§© é¢†åŸŸæ¨¡å‹æ¦‚å¿µ

### æ ¸å¿ƒé¢†åŸŸæ¦‚å¿µå›¾

```mermaid
classDiagram
    class Project {
        +String name
        +ProjectType type
        +Float area
        +String location
        +QualityLevel quality
        +DateTime createdAt
        +createEstimate()
        +updateEstimate()
    }

    class CostEstimate {
        +String id
        +Project project
        +CostTemplate template
        +CostBreakdown breakdown
        +EstimateStatus status
        +DateTime createdAt
        +calculate()
        +validate()
        +export()
    }

    class CostBreakdown {
        +Float totalCost
        +Float unitCost
        +List~PrimarySection~ primarySections
        +List~SecondarySection~ secondarySections
        +calculateHierarchy()
        +validateMathRelations()
    }

    class CostTemplate {
        +String id
        +String name
        +String region
        +Integer baseYear
        +List~TemplateSection~ sections
        +isActive()
        +getSimilarity()
    }

    class Document {
        +String id
        +String filename
        +DocumentType type
        +ProcessingStatus status
        +DateTime createdAt
        +process()
        +extractText()
        +chunk()
    }

    class Query {
        +String id
        +String question
        +QueryType type
        +String context
        +List~Source~ sources
        +Answer answer
        +retrieve()
        +generateAnswer()
    }

    class Answer {
        +String content
        +Float confidence
        +List~Source~ sources
        +DateTime createdAt
        +validate()
        +format()
    }

    class KnowledgeEntity {
        +String id
        +String name
        +EntityType type
        +Map~String,Object~ properties
        +List~EntityRelation~ relations
        +findRelated()
        +calculateSimilarity()
    }

    Project "1" --> "*" CostEstimate
    CostEstimate "1" --> "1" CostBreakdown
    CostEstimate "1" --> "1" CostTemplate
    Document "1" --> "*" Query
    Query "1" --> "1" Answer
    KnowledgeEntity "1" --> "*" EntityRelation
```

### å€¼å¯¹è±¡ (Value Objects)

#### 1. Money (é‡‘é¢)
```python
class Money:
    def __init__(self, amount: float, currency: str = "CNY"):
        if amount < 0:
            raise ValueError("é‡‘é¢ä¸èƒ½ä¸ºè´Ÿæ•°")
        self._amount = round(amount, 2)
        self._currency = currency

    @property
    def amount(self) -> float:
        return self._amount

    @property
    def currency(self) -> str:
        return self._currency

    def add(self, other: 'Money') -> 'Money':
        if self.currency != other.currency:
            raise ValueError("è´§å¸å•ä½ä¸ä¸€è‡´")
        return Money(self.amount + other.amount, self.currency)

    def multiply(self, multiplier: float) -> 'Money':
        return Money(self.amount * multiplier, self.currency)
```

#### 2. Area (é¢ç§¯)
```python
class Area:
    def __init__(self, square_meters: float):
        if square_meters <= 0:
            raise ValueError("é¢ç§¯å¿…é¡»å¤§äº0")
        self._square_meters = round(square_meters, 2)

    @property
    def square_meters(self) -> float:
        return self._square_meters

    def to_square_feet(self) -> float:
        return self._square_meters * 10.764
```

#### 3. QualityLevel (è´¨é‡ç­‰çº§)
```python
class QualityLevel(Enum):
    LOW = "low"
    MEDIUM = "medium"
    HIGH = "high"

    def adjustment_factor(self) -> float:
        factors = {
            QualityLevel.LOW: 0.85,
            QualityLevel.MEDIUM: 1.00,
            QualityLevel.HIGH: 1.20
        }
        return factors[self]
```

## ğŸ—ºï¸ é™ç•Œä¸Šä¸‹æ–‡æ˜ å°„

### ä¸Šä¸‹æ–‡å…³ç³»å›¾

```mermaid
graph TB
    subgraph "Core Context"
        A[é¡¹ç›®ä¼°ç®—ä¸Šä¸‹æ–‡<br/>Project Estimation Context]
        B[æ–‡æ¡£ç®¡ç†ä¸Šä¸‹æ–‡<br/>Document Management Context]
    end

    subgraph "Supporting Contexts"
        C[æ™ºèƒ½é—®ç­”ä¸Šä¸‹æ–‡<br/>Intelligent Q&A Context]
        D[å¤šé¡¹ç›®å¯¹æ¯”ä¸Šä¸‹æ–‡<br/>Multi-Project Comparison Context]
        E[çŸ¥è¯†å›¾è°±ä¸Šä¸‹æ–‡<br/>Knowledge Graph Context]
    end

    subgraph "Generic Contexts"
        F[ç”¨æˆ·ç®¡ç†ä¸Šä¸‹æ–‡<br/>User Management Context]
        G[ç³»ç»Ÿç®¡ç†ä¸Šä¸‹æ–‡<br/>System Management Context]
    end

    A -.-> B : Customer/Supplier
    A -.-> C : Published Language
    A -.-> D : Open Host Service
    A -.-> E : Partnership

    B -.-> C : Published Language
    B -.-> E : Partnership
    B -.-> D : Conformist

    C -.-> E : Partnership
    D -.-> E : Partnership

    A -.-> F : Customer/Supplier
    B -.-> F : Customer/Supplier
    C -.-> F : Customer/Supplier
    D -.-> F : Customer/Supplier

    A -.-> G : Customer/Supplier
    B -.-> G : Customer/Supplier
```

### ä¸Šä¸‹æ–‡è¯¦ç»†å®šä¹‰

#### 1. é¡¹ç›®ä¼°ç®—ä¸Šä¸‹æ–‡ (Project Estimation Context)

**èŒè´£**:
- å·¥ç¨‹é¡¹ç›®æˆæœ¬ä¼°ç®—
- æˆæœ¬æ¨¡æ¿ç®¡ç†
- ä¼°ç®—ç»“æœéªŒè¯
- æˆæœ¬åˆ†ææŠ¥å‘Š

**æ ¸å¿ƒæ¨¡å‹**:
- Project (é¡¹ç›®)
- CostEstimate (æˆæœ¬ä¼°ç®—)
- CostBreakdown (æˆæœ¬åˆ†è§£)
- CostTemplate (æˆæœ¬æ¨¡æ¿)

**æ¥å£**:
```python
class CostEstimationService:
    def create_estimate(self, project_data: ProjectData) -> CostEstimate
    def get_estimate(self, estimate_id: str) -> CostEstimate
    def update_estimate(self, estimate_id: str, updates: EstimateUpdates) -> CostEstimate
    def export_estimate(self, estimate_id: str, format: str) -> bytes
```

#### 2. æ–‡æ¡£ç®¡ç†ä¸Šä¸‹æ–‡ (Document Management Context)

**èŒè´£**:
- æ–‡æ¡£ä¸Šä¼ å’Œå¤„ç†
- æ–‡æœ¬æå–å’Œåˆ†å—
- OCRè¯†åˆ«
- æ–‡æ¡£å…ƒæ•°æ®ç®¡ç†

**æ ¸å¿ƒæ¨¡å‹**:
- Document (æ–‡æ¡£)
- DocumentChunk (æ–‡æ¡£åˆ†å—)
- ProcessingJob (å¤„ç†ä»»åŠ¡)
- ExtractionResult (æå–ç»“æœ)

**æ¥å£**:
```python
class DocumentService:
    def upload_document(self, file: UploadFile) -> Document
    def process_document(self, document_id: str) -> ProcessingJob
    def get_document(self, document_id: str) -> Document
    def search_documents(self, query: SearchQuery) -> List[Document]
```

#### 3. æ™ºèƒ½é—®ç­”ä¸Šä¸‹æ–‡ (Intelligent Q&A Context)

**èŒè´£**:
- RAGæŸ¥è¯¢å¤„ç†
- ç­”æ¡ˆç”Ÿæˆ
- å¯¹è¯ç®¡ç†
- çŸ¥è¯†æ£€ç´¢

**æ ¸å¿ƒæ¨¡å‹**:
- Query (æŸ¥è¯¢)
- Answer (ç­”æ¡ˆ)
- Conversation (å¯¹è¯)
- RetrievalResult (æ£€ç´¢ç»“æœ)

**æ¥å£**:
```python
class QueryService:
    def submit_query(self, question: str, context: QueryContext) -> Query
    def get_answer(self, query_id: str) -> Answer
    def continue_conversation(self, conversation_id: str, question: str) -> Answer
```

## ğŸ“‹ é¢†åŸŸäº‹ä»¶è®¾è®¡

### æ ¸å¿ƒé¢†åŸŸäº‹ä»¶

#### 1. é¡¹ç›®ä¼°ç®—äº‹ä»¶

```python
# é¡¹ç›®åˆ›å»ºäº‹ä»¶
class ProjectCreated(DomainEvent):
    def __init__(self, project_id: str, project_name: str, project_type: str):
        self.project_id = project_id
        self.project_name = project_name
        self.project_type = project_type
        self.occurred_at = datetime.now()

# æˆæœ¬ä¼°ç®—å®Œæˆäº‹ä»¶
class EstimateCalculated(DomainEvent):
    def __init__(self, estimate_id: str, total_cost: Money, unit_cost: Money):
        self.estimate_id = estimate_id
        self.total_cost = total_cost
        self.unit_cost = unit_cost
        self.occurred_at = datetime.now()

# ä¼°ç®—éªŒè¯å¤±è´¥äº‹ä»¶
class EstimateValidationFailed(DomainEvent):
    def __init__(self, estimate_id: str, errors: List[str]):
        self.estimate_id = estimate_id
        self.errors = errors
        self.occurred_at = datetime.now()
```

#### 2. æ–‡æ¡£ç®¡ç†äº‹ä»¶

```python
# æ–‡æ¡£ä¸Šä¼ äº‹ä»¶
class DocumentUploaded(DomainEvent):
    def __init__(self, document_id: str, filename: str, file_type: str):
        self.document_id = document_id
        self.filename = filename
        self.file_type = file_type
        self.occurred_at = datetime.now()

# æ–‡æ¡£å¤„ç†å®Œæˆäº‹ä»¶
class DocumentProcessed(DomainEvent):
    def __init__(self, document_id: str, chunks_count: int, entities_count: int):
        self.document_id = document_id
        self.chunks_count = chunks_count
        self.entities_count = entities_count
        self.occurred_at = datetime.now()

# å®ä½“æå–äº‹ä»¶
class EntityExtracted(DomainEvent):
    def __init__(self, document_id: str, entities: List[ExtractedEntity]):
        self.document_id = document_id
        self.entities = entities
        self.occurred_at = datetime.now()
```

#### 3. æ™ºèƒ½é—®ç­”äº‹ä»¶

```python
# æŸ¥è¯¢æäº¤äº‹ä»¶
class QuerySubmitted(DomainEvent):
    def __init__(self, query_id: str, question: str, context_type: str):
        self.query_id = query_id
        self.question = question
        self.context_type = context_type
        self.occurred_at = datetime.now()

# ç­”æ¡ˆç”Ÿæˆäº‹ä»¶
class AnswerGenerated(DomainEvent):
    def __init__(self, query_id: str, answer: str, confidence: float):
        self.query_id = query_id
        self.answer = answer
        self.confidence = confidence
        self.occurred_at = datetime.now()

# æŸ¥è¯¢åé¦ˆäº‹ä»¶
class QueryFeedbackReceived(DomainEvent):
    def __init__(self, query_id: str, rating: int, feedback: str):
        self.query_id = query_id
        self.rating = rating
        self.feedback = feedback
        self.occurred_at = datetime.now()
```

### äº‹ä»¶å¤„ç†æ¨¡å¼

#### äº‹ä»¶å‘å¸ƒå™¨
```python
class DomainEventPublisher:
    def __init__(self):
        self._handlers = defaultdict(list)

    def subscribe(self, event_type: Type[DomainEvent], handler: Callable):
        self._handlers[event_type].append(handler)

    def publish(self, event: DomainEvent):
        event_type = type(event)
        for handler in self._handlers[event_type]:
            # å¼‚æ­¥æ‰§è¡Œå¤„ç†å™¨
            asyncio.create_task(handler(event))
```

#### äº‹ä»¶å¤„ç†å™¨
```python
class EstimateEventHandler:
    def __init__(self, email_service: EmailService, notification_service: NotificationService):
        self.email_service = email_service
        self.notification_service = notification_service

    @event_handler(EstimateCalculated)
    async def handle_estimate_calculated(self, event: EstimateCalculated):
        # å‘é€é‚®ä»¶é€šçŸ¥
        await self.email_service.send_completion_notification(event.estimate_id)

        # æ›´æ–°é¡¹ç›®çŠ¶æ€
        await self.notification_service.update_project_status(event.estimate_id, "completed")
```

## ğŸ”— èšåˆæ ¹è®¾è®¡

### 1. é¡¹ç›®ä¼°ç®—èšåˆæ ¹

```python
class CostEstimateAggregate:
    def __init__(self, project: Project):
        self._project = project
        self._estimate = None
        self._breakdown = None
        self._events = []

    def create_estimate(self, template: CostTemplate, quality_level: QualityLevel) -> CostEstimate:
        if self._estimate:
            raise ValueError("ä¼°ç®—å·²å­˜åœ¨")

        self._estimate = CostEstimate.create(self._project, template)
        self._breakdown = CostBreakdownCalculator.calculate(
            self._project.area, template, quality_level
        )

        # éªŒè¯æ•°å­¦å…³ç³»
        validation_result = self._breakdown.validate()
        if not validation_result.is_valid:
            raise ValidationError(validation_result.errors)

        # è®°å½•é¢†åŸŸäº‹ä»¶
        self._events.append(EstimateCalculated(
            self._estimate.id,
            self._breakdown.total_cost,
            self._breakdown.unit_cost
        ))

        return self._estimate

    def get_events(self) -> List[DomainEvent]:
        return self._events.copy()

    def clear_events(self):
        self._events.clear()
```

### 2. æ–‡æ¡£èšåˆæ ¹

```python
class DocumentAggregate:
    def __init__(self):
        self._document = None
        self._chunks = []
        self._entities = []
        self._events = []

    def process_upload(self, file_data: bytes, filename: str, document_type: str) -> Document:
        self._document = Document.create(filename, document_type)

        # å¼‚æ­¥å¤„ç†æ–‡æ¡£
        processing_result = DocumentProcessor.process(file_data)

        self._chunks = processing_result.chunks
        self._entities = processing_result.entities

        # è®°å½•äº‹ä»¶
        self._events.append(DocumentUploaded(self._document.id, filename, document_type))
        self._events.append(DocumentProcessed(
            self._document.id,
            len(self._chunks),
            len(self._entities)
        ))

        return self._document
```

## ğŸ“š æˆ˜ç•¥è®¾è®¡åŸåˆ™

### 1. é¢†åŸŸé©±åŠ¨è®¾è®¡åŸåˆ™

- **æˆ˜ç•¥è®¾è®¡ä¼˜å…ˆ**: ä»ä¸šåŠ¡æˆ˜ç•¥å‡ºå‘è®¾è®¡é¢†åŸŸæ¨¡å‹
- **é™ç•Œä¸Šä¸‹æ–‡**: æ˜ç¡®çš„é¢†åŸŸè¾¹ç•Œå’ŒèŒè´£åˆ’åˆ†
- **é€šç”¨è¯­è¨€**: æŠ€æœ¯æœ¯è¯­ä¸ä¸šåŠ¡æœ¯è¯­ä¿æŒä¸€è‡´
- **é¢†åŸŸå»ºæ¨¡**: å»ºç«‹åæ˜ ä¸šåŠ¡æœ¬è´¨çš„é¢†åŸŸæ¨¡å‹

### 2. æ¶æ„è®¾è®¡åŸåˆ™

- **é«˜å†…èšä½è€¦åˆ**: é¢†åŸŸå†…éƒ¨é«˜å†…èšï¼Œé¢†åŸŸä¹‹é—´ä½è€¦åˆ
- **ä¾èµ–å€’ç½®**: é«˜å±‚æ¨¡å—ä¸ä¾èµ–ä½å±‚æ¨¡å—
- **æ¥å£éš”ç¦»**: å®¢æˆ·ç«¯ä¸åº”è¯¥ä¾èµ–å®ƒä¸éœ€è¦çš„æ¥å£
- **å•ä¸€èŒè´£**: ä¸€ä¸ªç±»åªåº”è¯¥æœ‰ä¸€ä¸ªæ”¹å˜çš„ç†ç”±

### 3. æ•°æ®è®¾è®¡åŸåˆ™

- **èšåˆæ ¹ä¸€è‡´æ€§**: é€šè¿‡èšåˆæ ¹ä¿è¯æ•°æ®ä¸€è‡´æ€§
- **æœ€ç»ˆä¸€è‡´æ€§**: è·¨èšåˆæ ¹æ“ä½œä½¿ç”¨æœ€ç»ˆä¸€è‡´æ€§
- **äº‹ä»¶æº¯æº**: è®°å½•é¢†åŸŸäº‹ä»¶ç”¨äºçŠ¶æ€é‡å»º
- **è¯»å†™åˆ†ç¦»**: CQRSæ¨¡å¼åˆ†ç¦»è¯»å†™æ“ä½œ

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

- **é¢†åŸŸè®¾è®¡æ–‡æ¡£**: [å®ä½“ä¸å€¼å¯¹è±¡](./entities-value-objects.md)
- **ä»“å‚¨æ¨¡å¼**: [ä»“å‚¨æ¥å£è®¾è®¡](./repository-patterns.md)
- **é¢†åŸŸæœåŠ¡**: [é¢†åŸŸæœåŠ¡è®¾è®¡](./domain-services.md)
- **è¾¹ç•Œä¸Šä¸‹æ–‡**: [é™ç•Œä¸Šä¸‹æ–‡æ˜ å°„](./bounded-contexts.md)
- **æŠ€æœ¯æ”¯æŒ**: support@cost-rag.com